   # Бизнес‑логика проекта

Этот документ описывает, как работает бот с точки зрения бизнес‑процессов: источники данных, правила, сценарии и состояния.

## 1) Роли и цели
- **Покупатель** (Telegram‑клиент): смотрит каталог, формирует корзину, оформляет заказ.
- **Система** (бот): показывает ассортимент, проверяет доступность, принимает данные заказа, формирует счёт, пишет в таблицы.
- **Администратор** (владелец таблицы): управляет ассортиментом и настройками в Google Sheets.

## 2) Источники данных и «истина»
1. **Google Sheets** — источник правды для каталога, настроек и заказов:
   - «Склад» — товары, цены, остатки, теги, активность, фото.
   - «Настройки» — бизнес‑настройки (минимальная сумма заказа и др.).
   - «Заказы» — журнал заказов.
   - «Списание» — списание со склада (опционально).
2. **SQLite** — оперативное состояние пользователя:
   - корзина, режим AI, история диалога, сессии оформления (идемпотентность).

## 3) Основные сущности
- **Товар**: `sku`, `name`, `price_rub`, `stock`, `tags`, `photo_url`, `desc_short`.
- **Корзина**: список `(sku, qty)` по `user_id`.
- **Заказ**: итог по корзине + телефон + доставка + PDF‑счёт.
- **Сессия оформления**: привязана к хэшу корзины и защищает от дублей.

## 4) Точки входа пользователя
### 4.1 /start и меню
- При `/start` бот включает **AI‑режим** по умолчанию и показывает постоянное меню.
- Дополнительные действия открываются через inline‑кнопки «Меню», «Каталог», «Корзина», «Условия».
- «Условия» читаются из «Настройки» (минимальная сумма и др.).

### 4.2 Каталог
- Пользователь нажимает **«Каталог»** или попадает в список из меню.
- Бот показывает карточку товара с фото и кнопками:
  - Добавить в корзину (1 или 5 шт.)
  - Навигация по страницам
  - Переходы: «Категории», «Поиск», «Корзина», «Меню».
- Показываются только товары:
  - активные (по колонке «Активен»),
  - с положительной ценой,
  - с положительным остатком.

### 4.3 Категории
- Категории строятся из тегов товаров (разделитель `,`).
- Категория — фильтр по вхождению в `tags` (case‑insensitive).

### 4.4 Поиск
- Поиск — FSM: бот просит строку и ищет по:
  - названию,
  - тегам,
  - краткому описанию,
  - SKU.
- В ответе показывается до 10 товаров + текст, если найдено больше.

### 4.5 Карточка товара
- По клику на товар (например из корзины) показывается подробная карточка.
- Кнопки: «В корзину (1/5)», «Корзина», «Назад».

## 5) Корзина: правила и сценарии
### 5.1 Добавление в корзину
Бизнес‑правила в `CartService.add_to_cart`:
- **SKU обязан существовать** — иначе отказ.
- **Остаток > 0** — иначе отказ «товар закончился».
- **Нельзя превысить остаток**: учитывается уже добавленное количество.
- Успех возвращает сообщение с итоговым количеством позиций в корзине.

### 5.2 Просмотр корзины
- Корзина собирается из SQLite и пересчитывается по актуальным ценам.
- Показывается:
  - список позиций (название, количество, цена, сумма),
  - итоговая сумма,
  - предупреждение о минимальной сумме, если ниже лимита.

### 5.3 Управление корзиной
- Кнопки `+` и `-` меняют количество по SKU.
- Если количество становится `<= 0` — позиция удаляется.
- «Очистить» — удаляет все позиции.

## 6) Оформление заказа (FSM)
Оформление — FSM с проверками и ветвлением:
1. **Проверка корзины**:
   - если пусто — ошибка «Корзина пустая».
   - если сумма ниже минимальной — отказ с подсказкой.
2. **Телефон**:
   - валидируется регулярным выражением (международный формат `+7999...`).
   - неверный формат → повторный запрос.
3. **Доставка**:
   - если СДЭК недоступен → ручной ввод адреса.
   - если СДЭК доступен → выбор города и ПВЗ (см. раздел 7).
4. **Финализация**:
   - генерация PDF‑счёта,
   - запись заказа в Google Sheets,
   - опциональное списание,
   - очистка корзины и завершение FSM.

## 7) Доставка через СДЭК (опционально)
### 7.1 Включение режима
- Если есть `CDEK_CLIENT_ID` и `CDEK_CLIENT_SECRET` → используется реальный API.
- Иначе, если `CDEK_DEMO_MODE=true` → используется демо‑клиент (без HTTP).
- Иначе СДЭК считается недоступным, и бот просит ввод вручную.

### 7.2 Сценарий СДЭК
1. **Ввод города**:
   - пользователь вводит строку города.
   - если меньше 2 символов или город не найден → повторный ввод.
   - специальное слово «вручную» → ручной ввод доставки.
2. **Выбор города**:
   - бот предлагает список городов (до 10).
3. **Выбор ПВЗ**:
   - бот запрашивает список ПВЗ и показывает с пагинацией.
4. **Подтверждение**:
   - бот показывает адрес/время работы ПВЗ.
   - подтверждение → доставка фиксируется как строка:
     - `ПВЗ СДЭК: <адрес> (<код>)`.

## 8) Финализация заказа
### 8.1 Идемпотентность
- Заказ создаётся на основе **хэша корзины**.
- Если пользователь повторит оформление с тем же набором — используется уже созданный `order_id`.
- После успешной записи — сессия помечается как `completed`.

### 8.2 Генерация PDF‑счёта
- Счёт формируется из:
  - данных продавца из «Настройки»,
  - телефона покупателя,
  - строки доставки,
  - списка позиций `(sku, name, qty, price)`.
- Файл сохраняется в `/app/data/invoices/<order_id>.pdf`.

### 8.3 Запись заказа в Google Sheets
В лист «Заказы» добавляется строка:
- `order_id`, дата/время, `user_id`, телефон,
- статус «Счет выставлен»,
- сумма, доставка, список позиций `sku:qty`,
- имя PDF.

### 8.4 Списание (опционально)
- Если `AUTO_WRITE_SPISANIE=true`:
  - пишутся строки в «Списание»,
  - увеличивается колонка «Списано» в «Склад»,
  - кеш товаров сбрасывается.

## 9) AI‑менеджер
### 9.1 Включение
- Режим AI включается по `/start` и кнопкой «AI Менеджер».
- Без `OPENAI_API_KEY` AI отключается, бот предлагает пользоваться кнопками.

### 9.2 Как AI работает
- AI использует **tool calling** и выполняет операции через реальные функции:
  - `list_all_products` — список товаров,
  - `search_products` — поиск,
  - `add_to_cart` — добавление,
  - `show_cart` — корзина,
  - `checkout_hint` — подсказка по оформлению.
- История чата хранится в SQLite (последние 20 сообщений).
- После ответа AI бот показывает быстрые действия (кнопки корзины).

## 10) Кеширование
- Каталог, настройки и категории кешируются на 60 секунд.
- При списании со склада кеш принудительно сбрасывается.

## 11) Валидации и ограничения
- Телефон должен быть в международном формате `+7...` (10–15 цифр).
- Товар должен быть активен и иметь остаток > 0.
- Нельзя добавить в корзину больше доступного остатка.
- Оформление запрещено ниже минимальной суммы из «Настройки».

## 12) Ошибки и пользовательский опыт
- Любая необработанная ошибка перехватывается глобальным хендлером:
  - пользователю показывается понятное сообщение с рекомендацией начать заново.
- Ошибки внешних сервисов (Sheets, CDEK, AI) логируются и приводят к мягким отказам.

## 13) Где смотреть реализацию
- Вход и регистрация: `app/main.py`
- Каталог и поиск: `app/handlers/catalog.py`
- Корзина и оформление: `app/handlers/cart.py`
- AI‑режим: `app/handlers/ai.py`, `app/ai_manager.py`
- СДЭК: `app/cdek.py`, `app/keyboards.py`
- Доступ к Google Sheets: `app/sheets.py`
- Бизнес‑правила корзины: `app/services/cart_service.py`
