<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>

# Owner Bot — Developer Notes

## Callback Data Conventions

**CRITICAL:** Все callback_data должны быть уникальными для предотвращения collision между хэндлерами.

| Handler File | Callback Pattern | Purpose |
|--------------|------------------|---------|
| `intake.py` | `confirm` | Подтверждение создания товара |
| `intake.py` | `cancel` | Отмена операции |
| `intake.py` | `skip_photo` | Пропустить загрузку фото |
| `intake.py` | `keep_photo` | Оставить текущее фото |
| `intake.py` | `edit_*` | Редактирование полей |
| `health.py` | `cleanup_confirm` | Подтверждение очистки файлов |
| `products.py` | `product_intake_<row>` | Приход для товара |
| `products.py` | `product_writeoff_<row>` | Списание товара |
| `products.py` | `product_correction_<row>` | Корректировка остатка |
| `products.py` | `product_photo_<row>` | Замена фото |
| `products.py` | `product_archive_<row>` | Архивация товара |
| `products.py` | `product_more_<row>` | Дополнительные действия |
| `products.py` | `product_back_<row>` | Назад к карточке |
| `products.py` | `writeoff_reason_*` | Выбор причины списания |
| `products.py` | `writeoff_all_<row>` | Списать весь остаток |
| `products.py` | `correction_reason_*` | Выбор причины корректировки |
| `products.py` | `archive_simple_<row>` | Архивация без обнуления |
| `products.py` | `archive_zero_<row>` | Архивация с обнулением |
| `products.py` | `confirm_action_<id>` | Подтверждение операции |
| `products.py` | `back_to_product` | Вернуться к карточке товара |
| `products.py` | `start_search` | Начать новый поиск |
| `stock.py` | `stock_page_<N>` | Пагинация списка товаров |
| `stock.py` | `stock_select_<row>` | Выбор товара из списка |
| `stock.py` | `stock_close` | Закрыть список товаров |

### Исправленный баг (2026-01-28)

**Проблема:** `health.py` использовал `F.data == "confirm"` без FSM state filter, перехватывая ВСЕ confirm callbacks, включая intake flow.

**Решение:** Изменён callback_data на `cleanup_confirm` для уникальности.

## FSM States (intake.py)

```
IntakeStates:
  waiting_input      → Ожидание ввода данных
  selecting_product  → Выбор существующего товара
  waiting_photo      → Ожидание фото
  analyzing_photo    → Анализ качества фото
  confirming         → Предпросмотр и подтверждение
```

## FSM States (products.py - Stock Operations)

```
ProductState:
  searching          → Поиск товара
  viewing            → Просмотр карточки

StockOperationState:
  writeoff_qty       → Ввод количества для списания
  writeoff_reason    → Выбор причины списания
  writeoff_confirm   → Подтверждение списания
  correction_qty     → Ввод фактического остатка
  correction_reason  → Выбор причины корректировки
  correction_confirm → Подтверждение корректировки
  archive_menu       → Выбор режима архивации
  archive_confirm    → Подтверждение архивации
```

## Google Sheets Column Mapping

### Лист "Склад"

Колонки загружаются динамически из header row. Поддерживаемые алиасы:

| Internal Key | Accepts |
|--------------|---------|
| `Цена` | `Цена`, `Цена_руб` |
| `Остаток` | `Остаток`, `Остаток_расчет` |
| `Фото` | `Фото`, `Фото_URL` |

### Листы "Внесение" и "Списание" (v1.1)

**Структура двухстрочных заголовков:**
- Row 1: Английские заголовки (для кода)
- Row 2: Русские описания (для пользователей)
- Row 3+: Данные

**Колонки (LOG_COLUMNS):**
```
A: date           → Дата
B: operation_id   → ID операции
C: sku            → Артикул
D: name           → Название
E: qty            → Количество
F: stock_before   → Было на складе
G: stock_after    → Стало на складе
H: reason         → Причина
I: source         → Источник
J: actor_id       → ID актора
K: actor_username → Имя актора
L: note           → Примечание
```

**Формулы в Склад используют:**
- `Внесение!C:C` (sku) и `Внесение!E:E` (qty)
- `Списание!C:C` (sku) и `Списание!E:E` (qty)

## Photo Upload Flow

1. Telegram → tmp file
2. Quality analysis (size, sharpness, brightness)
3. Optional enhancement (denoise, crop)
4. Upload to Google Drive
5. Get shareable URL
6. Write URL to Google Sheets

## Stock Operations (sheets.py)

### Методы логирования

| Метод | Лист | Описание |
|-------|------|----------|
| `apply_intake()` | Внесение | Логирует приход, инкрементирует `Внесено_всего` |
| `apply_writeoff()` | Списание | Логирует списание, обновляет остаток, инкрементирует `Списано_всего` |
| `apply_correction()` | Внесение/Списание | В зависимости от delta (+ или -) |
| `apply_archive_zero_out()` | Списание | Списывает весь остаток + деактивирует |

### Сигнатура apply_intake()

```python
async def apply_intake(
    self,
    row_number: int,
    qty: int,
    stock_before: int,      # Передаётся извне!
    stock_after: int,       # Передаётся извне!
    reason: str,            # "new_product", "intake"
    actor_id: int,
    actor_username: str,
    operation_id: str | None = None,
    note: str = "",
) -> StockOperationResult
```

**Важно:** `stock_before`/`stock_after` передаются как параметры (не вычисляются внутри), т.к. метод вызывается ПОСЛЕ обновления остатка.

### Вызов из intake_service.py

```python
# Для нового товара
await sheets_client.apply_intake(
    row_number=product.row_number,
    qty=session.quantity,
    stock_before=0,
    stock_after=session.quantity,
    reason="new_product",
    ...
)

# Для существующего товара
await sheets_client.apply_intake(
    row_number=session.existing_product.row_number,
    qty=session.quantity,
    stock_before=session.existing_product.stock,
    stock_after=product.stock,
    reason="intake",
    ...
)
```

### Self-Heal для листов логов

Листы "Внесение" и "Списание" создаются автоматически при первой записи.
Колонки добавляются автоматически если отсутствуют (`ensure_log_columns()`).

### Дедупликация

Каждая операция имеет `operation_id` (hex token). При повторном вызове с тем же ID операция не дублируется (`_check_operation_exists()`).

## Security

- Owner whitelist via `OWNER_TELEGRAM_IDS`
- Dangerous actions require confirmation (`ConfirmStore` with 5min TTL)
- Service account credentials via env vars only
