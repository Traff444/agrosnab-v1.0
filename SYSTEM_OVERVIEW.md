# Система управления магазином — Обзор

Два Telegram-бота для управления интернет-магазином с интеграцией Google Sheets.

## Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                        Google Sheets                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   Склад     │  │   Заказы    │  │  Списание   │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
└─────────┼────────────────┼────────────────┼─────────────────────┘
          │                │                │
          ▼                ▼                ▼
┌─────────────────┐              ┌─────────────────┐
│   OWNER BOT     │              │    SHOP BOT     │
│  @tophitboss_bot│              │  @agrosna1b_bot │
│                 │              │                 │
│  • Приход       │              │  • Каталог      │
│  • Управление   │◄────────────►│  • Корзина      │
│  • Фото         │   (Sheets)   │  • Заказы       │
│  • Диагностика  │              │  • AI-менеджер  │
└────────┬────────┘              └────────┬────────┘
         │                                │
         ▼                                ▼
┌─────────────────┐              ┌─────────────────┐
│  Google Drive   │              │    CDEK API     │
│  (фото товаров) │              │  (доставка)     │
└─────────────────┘              └─────────────────┘
```

---

## 1. Owner Bot — Управление складом

**Бот:** [@tophitboss_bot](https://t.me/tophitboss_bot)
**Имя:** Управляющий магазина
**Назначение:** Приём товаров, управление каталогом, загрузка фото

### Команды

| Команда | Описание |
|---------|----------|
| `/start` | Главное меню |
| `/health` | Быстрая проверка системы |
| `/cleanup` | Очистка временных файлов |

### Функции главного меню

| Кнопка | Функция |
|--------|---------|
| 📦 Приход товара | Добавить новый товар или пополнить остаток |
| 📊 Склад | Просмотр всех товаров списком с пагинацией |
| 🔍 Найти товар | Поиск по SKU или названию |
| 📋 Заказы сегодня | Сводка заказов (в разработке) |
| 📊 CRM | Управление клиентами, воронка продаж |
| 🔧 Статус | Диагностика подключений |

### Приход товара — Процесс

```
1. Быстрый ввод: "Махорка СССР 500 10"
   → Название: Махорка СССР
   → Цена: 500 ₽
   → Количество: 10 шт.

2. Поиск похожих товаров
   → Найдено 2 похожих: выбрать или создать новый

3. Фото товара
   → Загрузить / Пропустить / Оставить текущее
   → Анализ качества (размер, резкость, яркость)
   → Автоулучшение (денойзинг, обрезка)

4. Предпросмотр и подтверждение
   → Запись в Google Sheets
   → Загрузка фото в Google Drive
```

### Управление товарами

- **Поиск**: по SKU (точный) или названию (содержит)
- **Просмотр склада**: все товары с пагинацией (8 на страницу)
- **Карточка товара**: SKU, название, цена, остаток, статус, теги
- **Действия**:
  - Быстрый приход (+N шт.)
  - Списание с причиной (порча, подарок, пересорт)
  - Корректировка остатка (инвентаризация, ошибки учёта)
  - Замена фото
  - Архивация (простая или с обнулением остатка)

### Безопасность

- **Whitelist**: доступ только по Telegram ID из `OWNER_TELEGRAM_IDS`
- **Подтверждения**: опасные действия требуют повторного нажатия (TTL 5 мин)

### Интеграции

| Сервис | Использование |
|--------|---------------|
| Google Sheets | Хранение каталога товаров |
| Google Drive | Хранение фотографий |

---

## 2. Shop Bot — Магазин для покупателей

**Бот:** [@agrosna1b_bot](https://t.me/agrosna1b_bot)
**Имя:** Магазин Махорки
**Назначение:** Каталог, корзина, оформление заказов

### Команды

| Команда | Описание |
|---------|----------|
| `/start` | Приветствие и меню |
| `/catalog` | Каталог товаров |
| `/cart` | Корзина |
| `/orders` | Мои заказы |
| `/help` | Помощь |

### Функции

#### Каталог
- Постраничный просмотр с фото
- Фильтрация по категориям (из тегов)
- Поиск по названию, SKU, тегам
- Быстрое добавление в корзину (+1 / +5)

#### Корзина
- Просмотр товаров и суммы
- Изменение количества (+/-)
- Удаление товаров
- Проверка минимальной суммы заказа
- Проверка остатков на складе

#### Оформление заказа

```
1. Ввод номера телефона
   → Валидация формата

2. Выбор доставки (CDEK)
   → Поиск города по названию
   → Выбор пункта выдачи (ПВЗ)
   → Адрес, режим работы, метро

3. Подтверждение заказа
   → Генерация PDF-счёта
   → Запись в Google Sheets
   → Автоматическое списание со склада
   → Отправка счёта пользователю
```

#### AI-менеджер

Естественно-языковой интерфейс на базе OpenAI:

```
Пользователь: "что есть?"
AI: Показывает каталог товаров

Пользователь: "добавь 3 махорки СССР"
AI: Добавляет в корзину

Пользователь: "сколько всего?"
AI: Показывает сумму корзины
```

### Интеграции

| Сервис | Использование |
|--------|---------------|
| Google Sheets | Каталог, заказы, списания |
| CDEK API v2 | Поиск городов и ПВЗ |
| OpenAI API | AI-менеджер (GPT-4) |

---

## 3. Google Sheets — Структура данных

### Лист "Склад"

| Колонка | Тип | Описание |
|---------|-----|----------|
| SKU | string | Уникальный идентификатор (PRD-YYYYMMDD-XXXX) |
| Наименование | string | Название товара |
| Описание_кратко | string | Краткое описание |
| Описание_полное | string | Полное описание |
| Цена_руб | number | Цена в рублях |
| Стартовый_остаток | number | Начальный остаток |
| Внесено_всего | number | Всего поступило |
| Списано_всего | number | Всего списано |
| Остаток_расчет | number | Текущий остаток (расчётный) |
| Поставщик_ID | string | ID поставщика |
| Фото_URL | url | Ссылка на фото в Drive |
| Активен | boolean | да/нет |
| Теги | string | Теги через запятую |

### Лист "Заказы"

| Колонка | Описание |
|---------|----------|
| order_id | Уникальный ID заказа |
| user_id | Telegram ID покупателя |
| phone | Телефон |
| delivery | Способ доставки |
| pickup_point | Адрес ПВЗ |
| items | Товары (JSON) |
| total_rub | Сумма заказа |
| created_at | Дата создания |

### Лист "Списание"

| Колонка | Описание |
|---------|----------|
| order_id | ID заказа |
| sku | SKU товара |
| qty | Количество |
| created_at | Дата списания |

---

## 4. Конфигурация

### Owner Bot (`.env`)

```bash
# Telegram
TELEGRAM_BOT_TOKEN=8015984812:AAH...
OWNER_TELEGRAM_IDS=481890  # Через запятую для нескольких

# Google
GOOGLE_SHEETS_ID=1r9rpm7WF1tAjPud8Dhpgsz...
GOOGLE_SERVICE_ACCOUNT_JSON_PATH=/path/to/service-account.json
DRIVE_FOLDER_ID=1BlVN_L21bhax8aFFVnThDoh...

# Настройки фото
PHOTO_MIN_SIZE=800
PHOTO_SHARPNESS_THRESHOLD=100.0
PHOTO_BRIGHTNESS_MIN=40
PHOTO_BRIGHTNESS_MAX=220

# Приложение
LOG_LEVEL=INFO
TIMEZONE=Europe/Vilnius
```

### Shop Bot (`.env`)

```bash
# Telegram
TELEGRAM_BOT_TOKEN=8384232147:AAF...

# Google
GOOGLE_SHEETS_ID=1r9rpm7WF1tAjPud8Dhpgsz...
GOOGLE_SERVICE_ACCOUNT_JSON_PATH=/path/to/service-account.json

# OpenAI (для AI-менеджера)
OPENAI_API_KEY=sk-proj-...
OPENAI_MODEL=gpt-4o

# CDEK (опционально)
CDEK_CLIENT_ID=...
CDEK_CLIENT_SECRET=...
CDEK_TEST_MODE=true
CDEK_DEMO_MODE=true  # Демо-режим без реальных запросов

# Автосписание
AUTO_WRITE_SPISANIE=true
```

---

## 5. Запуск

### Локальный запуск

```bash
# Owner Bot
cd owner_bot
cp .env.example .env
# Заполнить .env
source .venv/bin/activate
python -m app.main

# Shop Bot (в отдельном терминале)
cd ..
cp .env.example .env
# Заполнить .env
source .venv/bin/activate
python -m app.main
```

### Docker

#### Структура volumes

```
excel-telegram-bot-starter/
├── secrets/                    # Google Service Account (shared)
│   └── *.json
├── data/                       # Shop Bot data
├── docker-compose.yml          # Shop Bot
├── owner_bot/
│   ├── tmp/                    # Owner Bot temp files
│   ├── data/                   # Owner Bot data
│   └── docker-compose.yml      # Owner Bot
```

#### Shop Bot (`docker-compose.yml`)

```yaml
services:
  bot:
    volumes:
      - ./secrets:/run/secrets:ro  # Credentials
      - ./data:/app/data           # Data
```

`.env`:
```bash
GOOGLE_SERVICE_ACCOUNT_JSON_PATH=/run/secrets/your-file.json
```

#### Owner Bot (`owner_bot/docker-compose.yml`)

```yaml
services:
  owner-bot:
    volumes:
      - ./tmp:/app/tmp            # Temp files
      - ./data:/app/data          # Data
      - ../secrets:/app/secrets   # Credentials (from root)
```

`owner_bot/.env`:
```bash
GOOGLE_SERVICE_ACCOUNT_JSON_PATH=/app/secrets/your-file.json
```

#### Запуск

```bash
# Подготовка secrets
mkdir -p secrets
cp /path/to/service-account.json secrets/

# Shop Bot
docker compose up --build

# Owner Bot
cd owner_bot
docker compose up --build
```

---

## 6. Статусы функций

### Owner Bot

| Функция | Статус |
|---------|--------|
| Быстрый парсинг приходов | ✅ Работает |
| Поиск товаров | ✅ Работает |
| Создание товаров | ✅ Работает |
| Обновление остатков | ✅ Работает |
| Просмотр склада | ✅ Работает |
| Списание товаров | ✅ Работает |
| Корректировка остатков | ✅ Работает |
| Архивация товаров | ✅ Работает |
| Загрузка фото | ✅ Работает |
| Анализ качества фото | ✅ Работает |
| Улучшение фото | ✅ Работает |
| CRM | ✅ Работает |
| Диагностика системы | ✅ Работает |
| Заказы сегодня | 🚧 В разработке |

### Shop Bot

| Функция | Статус |
|---------|--------|
| Каталог с фото | ✅ Работает |
| Категории | ✅ Работает |
| Поиск | ✅ Работает |
| Корзина | ✅ Работает |
| Оформление заказа | ✅ Работает |
| PDF счета | ✅ Работает |
| CDEK интеграция | ✅ Работает |
| AI-менеджер | ✅ Работает |
| Автосписание | ✅ Работает |
| История заказов | ✅ Работает |

---

## 7. Ссылки

| Ресурс | URL |
|--------|-----|
| Owner Bot | https://t.me/tophitboss_bot |
| Shop Bot | https://t.me/agrosna1b_bot |
| Google Sheets | https://docs.google.com/spreadsheets/d/1r9rpm7WF1tAjPud8DhpgszpPQNVhfforh1XXyKNuR9A |
| Google Drive (фото) | https://drive.google.com/drive/folders/1BlVN_L21bhax8aFFVnThDohHLXRpR87Z |
